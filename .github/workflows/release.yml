name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Generate man page
        run: |
          swift package plugin generate-manual
          cp .build/plugins/GenerateManual/outputs/reminder/reminder.1 reminder.1

      - name: Build universal binary
        run: |
          # Build for arm64
          swift build -c release --arch arm64 --disable-sandbox
          mkdir -p .build/bin
          cp .build/arm64-apple-macosx/release/reminder .build/bin/reminder-arm64
          
          # Build for x86_64
          swift build -c release --arch x86_64 --disable-sandbox
          cp .build/x86_64-apple-macosx/release/reminder .build/bin/reminder-x86_64
          
          # Combine into universal binary
          lipo -create .build/bin/reminder-arm64 .build/bin/reminder-x86_64 -output ./reminder
          
          # Verify the universal binary
          file ./reminder
          lipo -info ./reminder

      - name: Ad-hoc sign binary
        run: |
          codesign -s - ./reminder
          codesign -v ./reminder

      - name: Verify binary
        run: |
          if ! ./reminder --version; then
            echo "Binary test failed"
            exit 1
          fi

      - name: Create zip archive
        run: |
          ARCHIVE_NAME="reminder-${{ steps.get_version.outputs.VERSION }}.zip"
          zip -j "$ARCHIVE_NAME" reminder
          if [ -f "reminder.1" ]; then
            zip -j "$ARCHIVE_NAME" reminder.1
          fi
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "Release ${{ steps.get_version.outputs.VERSION }}" \
            --generate-notes \
            "$ARCHIVE_NAME"
